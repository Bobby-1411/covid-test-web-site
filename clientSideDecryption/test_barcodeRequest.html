<head>
	<title>Request and decrypt barcode registration information</title>
	<script type="text/javascript" src="src/forge.min.js"></script>
	<script type="text/javascript" src="src/decrypt.js"></script>
</head>
<body>
	<div>
		Barcode:
		<input type="text" name="barcode" id="barcode">
		<button onclick="request(document.getElementById('barcode').value);">Request information</button>
	</div>
	<div id="result"></div>
	<div>
		<input type="file" name="privateKey" id="privateKey"><br>
		Private key password: <input type="password" name="ps" id="ps"> <br>
		<button onclick="decryptRegistrations()">Decrypt reginstration info</button>
	</div>
	<div id="registrations"></div>
	<script type="text/javascript">
		var registrations;

		function request(barcode) {
			if(!barcode) throw "Barcode is not defined";
			document.getElementById("registrations").innerHTML = "";
			registrations = [];

			fetch("http://localhost:8000/api/samples/?barcode=" + barcode)
				.then(res => res.json())
				.then(data => {
					console.log(data);
					if(data.length == 0) 
						document.getElementById("result").innerHTML = "Barcode not found"
					else {
						document.getElementById("result").innerHTML = "Barcode <b>" + data[0].barcode + "</b><br>" +
							"Access code: " +  data[0].access_code + "<h3>Events</h3>" 
						data[0].events.forEach(el => {
							document.getElementById("result").innerHTML += el.comment + " on " + el.updated_on + "<br>"
						})
						document.getElementById("result").innerHTML += "Found " + data[0].registrations.length + " registration entry";
						registrations = data[0].registrations;
					}
				});
		};
		
		function decryptData(data) {
			var file = document.getElementById("privateKey").files[0];
			var password = document.getElementById("ps").value;

			if (file) {
			  var reader = new FileReader();
			  reader.readAsText(file);
			  reader.onload = function (evt) {
			    res = decrypt(data, reader.result, password);
			    Object.keys(res).forEach(el => {
			    	document.getElementById("registrations").innerHTML += "<b>" +  el + "</b>: " + res[el] + "<br>"
			    })
			  }
			  reader.onerror = function (evt) {
			    document.getElementById("registrations").innerHTML = "error reading private key file";
			  }
			}
		};

		function decryptRegistrations() {
			document.getElementById("registrations").innerHTML = "";
			var requiredFields = [
				"address_encrypted",
				"aes_instance_iv",
				"contact_encrypted",
				"name_encrypted",
				"session_key_encrypted"
			];

			registrations.forEach((el, i) => {
				document.getElementById("registrations").innerHTML += "Registration " + (i + 1) + "<br>";

				var data = {};
				requiredFields.forEach(f => {
					data[f] = el[f];
				})
				decryptData(data);
			});
		}
	</script>
</body>